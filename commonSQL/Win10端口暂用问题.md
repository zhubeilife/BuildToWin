åŸæ–‡é“¾æ¥ï¼šhttps://www.cnblogs.com/liqing1009/p/15354088.html

åœ¨å¯ç”¨ Hyper-V åï¼Œæ€»æ˜¯ä¼šäº§ç”Ÿå„ç§ç«¯å£è¢«å ç”¨çš„é—®é¢˜

æˆ‘é‡åˆ°è¿‡çš„é—®é¢˜å°±æœ‰ï¼š

å¯åŠ¨ IDEA æ—¶ï¼ŒæŠ¥é”™ï¼š

java.net.BindException: Address already in use: bind

ä½¿ç”¨ Clash for Windows æ—¶ï¼ŒCould not connect to Clash Coreï¼Œæ—¥å¿—ï¼š

time="2020-07-28T07:08:37+08:00" level=error msg="External controller error: listen tcp 127.0.0.1:9090: bind: An attempt was made to access a socket in a way forbidden by its access permissions."

æ˜¾ç„¶ï¼Œè¿™ä¸¤ä¸ªé”™è¯¯éƒ½æ˜¯ç«¯å£è¢«å ç”¨é€ æˆçš„ã€‚

æ ¹æ®IDEA Start Failed: Address already in use - Serge Baranov çš„å›ç­”ï¼ŒIDEA ä¼šåœ¨ 6942~6991 ä¸­å¯»æ‰¾ä¸€ä¸ªç«¯å£å¹¶ bindã€‚ç”±æ­¤å¯è§ï¼Œé”™è¯¯åŸå› æ˜¯è¿™ 50 ä¸ªç«¯å£éƒ½å·²ç»è¢«å ç”¨ã€‚

æ ¹æ®æ—¥å¿—å†…å®¹ï¼Œç¬¬äºŒä¸ªé—®é¢˜æ˜¯ 9090 ç«¯å£è¢«å ç”¨é€ æˆçš„

å¯¹äºä¸€èˆ¬çš„ç«¯å£å ç”¨é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘çš„ 27891 è¢«å ç”¨ï¼Œå¯ä»¥å…ˆæŸ¥æ‰¾å‡ºæ­£åœ¨ä½¿ç”¨æ­¤ç«¯å£çš„è¿›ç¨‹ï¼Œå†å¼ºè¡Œç»ˆæ­¢è¿™ä¸ªè¿›ç¨‹ï¼ˆå¦‚æœå¤±è´¥å¯ä»¥è¯•è¯•ä»¥ç®¡ç†å‘˜èº«ä»½ï¼‰ï¼š

Copy
PS C:\Users\hyuuko> netstat -ano | findstr 27891
  TCP    127.0.0.1:8780         127.0.0.1:27891        SYN_SENT        6276
  TCP    127.0.0.1:8802         127.0.0.1:27891        SYN_SENT        6276
PS C:\Users\hyuuko> taskkill /pid 6276 /F
æˆåŠŸ: å·²ç»ˆæ­¢ PID ä¸º 6276 çš„è¿›ç¨‹ã€‚
PS C:\Users\hyuuko>
ç„¶è€Œï¼Œæˆ‘ä½¿ç”¨netstat -ano | findstr ç«¯å£å·å‘½ä»¤æ—¶ï¼Œå‘ç° 6942~6991 å’Œ 9090 å¹¶æœªè¢«æŸä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚è¿™è¯´æ˜è¿™äº›ç«¯å£å¯èƒ½æ˜¯è¢«ç³»ç»Ÿä¿ç•™äº†ï¼Œæ¯”å¦‚ Hyper-Vã€‚

æ ¹æ®List of TCP and UDP port numbers - Wikipediaæ‰€è¨€ï¼Œtcp/udp ç«¯å£å·è¢«åˆ†ä¸º 3 æ®µï¼š

ç«¯å£ç±»å‹	èŒƒå›´	ç”¨é€”
å‘¨çŸ¥ç«¯å£	0 - 1023	æä¾›å¹¿æ³›ä½¿ç”¨çš„ç½‘ç»œæœåŠ¡ç±»å‹çš„ç³»ç»Ÿè¿›ç¨‹ä½¿ç”¨
æ³¨å†Œç«¯å£	1024 - 49151	ç»™ç”¨æˆ·è¿›ç¨‹æˆ–åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œæ¯”å¦‚ IDEA
åŠ¨æ€ç«¯å£	49152-65535	ç”¨äºç§æœ‰æˆ–å®šåˆ¶æœåŠ¡ã€ä¸´æ—¶ç›®çš„ä»¥åŠä¸´æ—¶ç«¯å£çš„è‡ªåŠ¨åˆ†é…
Hyper-V ä¼šå°†åŠ¨æ€ç«¯å£ä¸­çš„å‡ æ®µèŒƒå›´çš„ç«¯å£ä¿ç•™ç»™è‡ªå·±ä½¿ç”¨ï¼Œç”¨æˆ·çš„åº”ç”¨ç¨‹åºæ— æ³•ä½¿ç”¨è¿™äº›ç«¯å£ã€‚ä» Windows Vista å’Œ Windows Server 2008 èµ·ï¼ŒWindows å°† 49152-65535 åˆ’åˆ†ä¸º åŠ¨æ€ç«¯å£ï¼Œè§Service overview and network port requirements for Windowsã€‚ç„¶è€Œåœ¨æŸæ¬¡æ›´æ–°åï¼ŒWindows çš„åŠ¨æ€ç«¯å£èŒƒå›´å˜æˆäº† 1024~15000ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åŠ¨æ€ç«¯å£èŒƒå›´å’Œè¢«ä¿ç•™çš„ç«¯å£èŒƒå›´ï¼š

Copy
# æŸ¥çœ‹tcp ipv4åŠ¨æ€ç«¯å£èŒƒå›´
PS C:\Users\hyuuko> netsh int ipv4 show dynamicport tcp

åè®® tcp åŠ¨æ€ç«¯å£èŒƒå›´
---------------------------------
å¯åŠ¨ç«¯å£        : 1024
ç«¯å£æ•°          : 13977

# æŸ¥çœ‹tcp ipv4ç«¯å£æ’é™¤èŒƒå›´ï¼ˆè¢«ç³»ç»Ÿæˆ–è€…æˆ‘ä»¬è‡ªå·±ä¿ç•™çš„ç«¯å£ï¼‰
PS C:\Users\hyuuko> netsh int ipv4 show excludedport tcp

åè®® tcp ç«¯å£æ’é™¤èŒƒå›´

å¼€å§‹ç«¯å£    ç»“æŸç«¯å£
----------    --------
      1578        1677
      1678        1777
å¤ªå¤šäº†è¿™é‡Œçœç•¥...
      8974        9073
      9074        9173
      9174        9273
å¤ªå¤šäº†è¿™é‡Œçœç•¥...
     11301       11400
     11401       11500
     50000       50059     *

* - ç®¡ç†çš„ç«¯å£æ’é™¤ã€‚

PS C:\Users\hyuuko>
å¯ä»¥çœ‹åˆ°ï¼Œ9074~9173 ç­‰ç­‰èŒƒå›´å†…çš„ç«¯å£è¢«ç³»ç»Ÿä¿ç•™äº†ï¼ˆç»å¯¹æ˜¯ Hyper-V å¹²çš„ï¼ï¼‰ï¼Œå¯¼è‡´ clash ä¸èƒ½ä½¿ç”¨ 9090 ç«¯å£ã€‚ç°åœ¨çŸ¥é“åŸå› äº†ï¼Œæœ‰ä¸‰ç§è§£å†³åŠæ³•ï¼ˆæˆ‘ç”¨çš„ç¬¬äºŒç§ï¼‰

ç¬¬ä¸€ç§è§£å†³åŠæ³•ï¼ˆä¸æ¨èï¼‰#
æ›´æ”¹ clash ä½¿ç”¨çš„ç«¯å£ï¼Œå°† 9090 æ”¹æˆè¾ƒé«˜çš„ 29091ï¼Œå¯æ˜¯æ²»æ ‡ä¸æ²»æœ¬ï¼Œå› ä¸º Hyper-V ä¸‹æ¬¡å¯èƒ½å°±ä¼šå°† 29091 ä¿ç•™ç»™è‡ªå·±ç”¨ã€‚å†è€…è€Œè¿™è¿˜ä¸èƒ½è§£å†³ IDEA çš„é—®é¢˜ï¼Œä½ ä¸èƒ½æ”¹å˜ IDEA æƒ³è¦ä½¿ç”¨çš„ç«¯å£ã€‚

ç¬¬äºŒç§è§£å†³åŠæ³•#
å…ˆä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ powershellï¼Œç„¶åè®¾ç½® tcp ipv4 çš„åŠ¨æ€ç«¯å£èŒƒå›´ä¸º 49152 å¼€å§‹çš„ 16384 ä¸ªç«¯å£ï¼Œä¹Ÿå°±æ˜¯ 49152~65535

Copy
netsh int ipv4 set dynamicport tcp start=49152 num=16384
ç„¶åé‡å¯ç”µè„‘ã€‚Hyper-V å°±ä¼šä» 49152~65535 èŒƒå›´å†…ä¿ç•™ä¸€éƒ¨åˆ†ç«¯å£ï¼Œ6942~6991 å’Œ 9090 ä¸å—å½±å“ã€‚

æŸ¥çœ‹ä¸€ä¸‹æ­¤æ—¶çš„åŠ¨æ€ç«¯å£èŒƒå›´ï¼š

Copy
PS C:\Users\hyuuko> netsh int ipv4 show dynamicport tcp

åè®® tcp åŠ¨æ€ç«¯å£èŒƒå›´
---------------------------------
å¯åŠ¨ç«¯å£        : 49152
ç«¯å£æ•°          : 16384
ç¬¬ä¸‰ç§è§£å†³åŠæ³•#
å…ˆä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ powershellï¼Œç„¶åå°† 9090 ç­‰ç«¯å£è®¾ç½®ä¸ºæ’é™¤ç«¯å£ç»™åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚

Copy
# ä¿ç•™ 6942~6951 è¿™10ä¸ªç«¯å£ç»™åº”ç”¨ç¨‹åºä½¿ç”¨
netsh int ipv4 add excludedportrange protocol=tcp startport=6942 numberofports=10
# ä¿ç•™ 9090 ç«¯å£ç»™åº”ç”¨ç¨‹åºä½¿ç”¨
netsh int ipv4 add excludedportrange protocol=tcp startport=9090 numberofports=1
ç„¶åé‡å¯ç”µè„‘ã€‚å› ä¸º 9090 ç­‰ç«¯å£è¢«ä¿ç•™ç»™åº”ç”¨ç¨‹åºä½¿ç”¨äº†ï¼ŒHyper-V å°±æ— æ³•å°† 9090 ä¿ç•™ç»™è‡ªå·±ä½¿ç”¨äº†ã€‚

æŸ¥çœ‹ä¸€ä¸‹æ­¤æ—¶è¢«ä¿ç•™çš„ç«¯å£ï¼š

Copy
PS C:\Users\hyuuko> netsh int ipv4 show excludedport tcp

åè®® tcp ç«¯å£æ’é™¤èŒƒå›´

å¼€å§‹ç«¯å£    ç»“æŸç«¯å£
----------    --------
      1578        1677
      1678        1777
å¤ªå¤šäº†è¿™é‡Œçœç•¥...
      9090        9090     *
å¤ªå¤šäº†è¿™é‡Œçœç•¥...
     11301       11400
     11401       11500
å¤ªå¤šäº†è¿™é‡Œçœç•¥...

* - ç®¡ç†çš„ç«¯å£æ’é™¤ã€‚
å¸¦æ˜Ÿå·çš„å°±æ˜¯è¢«ç®¡ç†å‘˜ä¿ç•™çš„ç«¯å£ï¼Œå¯ä»¥è¢«åº”ç”¨ç¨‹åºä½¿ç”¨

å¦‚æœè¦å–æ¶ˆä¿ç•™ç«¯å£ï¼Œå¯ä»¥ï¼š

Copy
netsh int ipv4 delete excludedportrange protocol=tcp startport=9090 numberofports=1
å‚è€ƒèµ„æ–™#
StackOverflow - Reserve a TCP port in Windows
StackOverflow - What is Administered port exclusions in windows 10?
æœ¬æ–‡åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæœ‰ç–‘é—®æ¬¢è¿è¯„è®ºå“¦ğŸ˜‰
